/*
 * Copyright (C) 2018 Frank Mertens.
 *
 * Distribution and use is allowed under the terms of the zlib license
 * (see cc/LICENSE-zlib).
 *
 */

#pragma once

#include <cc/Property>
#include <cc/System>
#include <cc/ui/Timer>

namespace cc {
namespace ui {

template<class T>
class Transition: public Object, private PropertyMutator<T>
{
public:
    typedef std::function<T(T, T, double)> Easing;

    static T linear(T a, T b, double r)
    {
        return (1 - r) * a + r * b;
    }

    static Transition *create(Property<T> &property, double duration, const Easing &easing = &linear)
    {
        Ref<Transition> transition = new Transition(property, duration, easing);
        Transition *self = transition;
        property->constrain([transition, self](T &newValue, T oldValue){
            if (self->isActive()) return false;
            self->start(oldValue, newValue);
            return false;
        });
        return transition;
    }

    void start(T oldValue, T newValue)
    {
        if (oldValue == newValue || timer_->isActive()) return;
        oldValue_ = oldValue;
        newValue_ = newValue;
        startTime_ = System::now();
        finishTime_ = startTime_ + duration_;
        timer_->startAt(startTime_ + timer_->interval());
    }

    bool isActive() const { return timer_->isActive(); }

private:
    Transition(Property<T> &property, double duration, const Easing &easing):
        alias_(alias(property)),
        duration_(duration),
        easing_(easing),
        timer_(Timer::create(1./60.)),
        finishTime_(0)
    {
        timer_->triggered->connect([this]{timeout();});
    }

    void timeout()
    {
        const double t0 = startTime_;
        const double t1 = finishTime_;
        const double t = System::now();

        if (t >= t1) {
            PropertyMutator<T>::store(alias_, newValue_);
            timer_->stop();
        }
        else {
            PropertyMutator<T>::store(
                alias_,
                easing_(
                    oldValue_, newValue_,
                    (t - t0) / (t1 - t0)
                )
            );
        }
    }

    Property<T> alias_;
    double duration_;
    Easing easing_;
    Ref<Timer> timer_;
    double startTime_;
    double finishTime_;
    T oldValue_;
    T newValue_;
};

}} // namespace cc::ui
