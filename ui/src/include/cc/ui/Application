/*
 * Copyright (C) 2017-2018 Frank Mertens.
 *
 * Distribution and use is allowed under the terms of the zlib license
 * (see cc/LICENSE-zlib).
 *
 */

#pragma once

#include <cc/ui/Window>
#include <cc/ui/Font>
#include <cc/ui/Cursor>
#include <cc/ui/TextInputFocus>

namespace cc { template<class> class Set; }

namespace cc {
namespace ui {

class Timer;
class PointerEvent;
class FingerEvent;

class Application: public Object
{
public:
    static Application *open(int argc, char **argv);
    static Application *instance();

    Property<bool> cursorVisible { true };
    Property<bool> screenSaverEnabled { false };

    Property<double> textZoom { 1 };
    Property<Font> defaultFont;
    Property<Font> smallFont;

    Property< Ref<const TextInputFocus> > textInputFocus;

    Property< Ref<Control> > hoverControl;
    Property< Ref<Control> > pressedControl;

    virtual Window *openWindow(View *view, String title = String{}, WindowMode mode = WindowMode::Default) = 0;

    virtual Ref<Cursor> createCursor(CursorShape shape) = 0;
    virtual const Cursor *cursor() const = 0;
    virtual void setCursor(const Cursor *cursor) = 0;
    virtual void unsetCursor() = 0;

    virtual String getClipboardText() const = 0;
    virtual void setClipboardText(String text) = 0;

    FontSmoothing fontSmoothing() const;
    void setTextSmoothing(FontSmoothing newValue) { fontSmoothing_ = newValue; }

    virtual int run() = 0;

    static bool fin() { return fin_; }

protected:
    friend class View;
    friend class TextInputFocus;

    static bool fin_;

    Application();
    ~Application();

    virtual void init(int argc, char **argv) = 0;

    virtual void startTextInput(const Window *window, const Rect &inputArea) = 0;
    virtual void stopTextInput() = 0;

    void notifyTimer(Timer *t);

    bool feedFingerEvent(Window *window, FingerEvent *event);
    bool feedMouseEvent(Window *window, MouseEvent *event);
    bool feedWheelEvent(Window *window, WheelEvent *event);
    bool feedKeyEvent(Window *window, KeyEvent *event);
    bool feedTextEditingEvent(const String &text, int start, int length);
    bool feedTextInputEvent(const String &text);

    FontSmoothing fontSmoothing_ { FontSmoothing::Default };

    typedef Map<TouchFingerId, Ref<Control> > TouchTargets; // FIXME: rename to TouchedControl
    Ref<TouchTargets> touchTargets_;

    Window *cursorWindow_ { nullptr };
};

}} // namespace cc::ui
